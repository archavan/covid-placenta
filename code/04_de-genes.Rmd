---
title: "Expression of DE genes"
author: "Arun Chavan"
output:
  html_notebook:
    toc: yes
    toc_float: yes
    number_sections: true
bibliography: ../refs.bib
---
Started: 2020-09-10  
Last edited: `r format(Sys.time())`

```{r message=FALSE}
library(tidyverse)

# single cell
library(Seurat)

# plotting
library(patchwork)
library(ggthemes)
```


# Background
Alice had performed bulk-RNA seq on the placenta sample from COVID-19 positive mothers and control placentas and has a list of genes that were differentially expressed. Here we will use the single-cell RNA seq data to figure out in which cell types those DE genes are expressed. 

# Data
I have already annotated the clusters. The annotated data (a `seurat` object) was saved as `.rds`, which we have to read. 

```{r}
seur <- readRDS("../results/02_annotation/seurat-object_annotated.rds")
```

```{r}
# set active assay
DefaultAssay(seur) <- "SCT"

# set levels for idents (use merged_annotations)
seur@meta.data$annotation_merged <- factor(seur@meta.data$annotation_merged,
                                           levels = sort(unique(seur@meta.data$annotation_merged)))

# set idents
Idents(seur) <- seur@meta.data$annotation_merged
```

# DE genes
Below are the DE genes sent by Alice. 

```{r}
genes <- list()

genes$focused <- c("HSPA1A", "PPP1R11", "LY6GLY6C", "ITGAX", "IFITM1", "C1QC", "CCL2", "OAS3", "MX1")
genes$analysis1 <- c("HSPA1A", "FMC1-LUC7L2", "HSPA1B",	"AC011511.4", "PPP1R11", "AL139300.1", "LY6GLY6C")
genes$analysis2 <- c("ITGAX", "OAS3", "IFITM1", "MX1", "C1QC", "MX2", "CCL2")
genes$additional <- c("C1QTNF2", "LYVE1", "TREM1", "FOLR2", "C1QB",	"CCL2", "TNFRSF10C", "CXCL9", "IL1R2", "IL36A", "CD28", "OAS1", "IL1RN", "CD36", "CXCR2",	"SERPING1", "CXCR1", "TNFRSF10C", "C1QA", "HCST", "IL36A", "IL4R", "LY96", "IL1R2", "CXCR2", "CXCL2", "S100A7", "IFITM3", "SELENOM", "SELENOP", "C3AR1", "CCL2", "CCL8")
genes$entry <- c("ACE2", "TMPRSS2", "BSG", "DPP4", "CTSL", "CTSB", "FURIN")

all.genes <- c(genes$focused, genes$analysis1, genes$analysis2, genes$additional, genes$entry) %>% 
  unique() %>% 
  sort()
```

# Plots
## Dotplot for all genes

```{r}
# dotplot function
DotPlot2 <- function(object = seur, assay = "SCT", features, title = "", ...) {
  p <- DotPlot(object, 
               assay = assay,
               features = features, 
               dot.scale = 4, 
               dot.min = 0.01,
               ...) +
    coord_flip() +
    labs(caption = paste0("sctransform normalized expression"), title = title) +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
          panel.grid.minor = element_blank(),
          panel.grid.major = element_line(size = 0.1),
          legend.key.size = unit(0.75, "line"))
  
  return(p)
}
```

```{r fig.asp=1.2, fig.width=6.5}
DotPlot2(features = all.genes)

cowplot::ggsave2(last_plot(), 
                 filename = "../results/03_de-genes/plots/dotplot_all-genes.pdf", 
                 width = 6.5, height = 8, units = "in")
```

## Individual genes
```{r}
# violin function
VlnPlot2 <- function(object = seur, assay = "SCT", feature, ...) {
  p <- VlnPlot(object = object, 
               features = feature, 
               assay = assay, 
               same.y.lims = FALSE,
               split.by = "covid", 
               split.plot = TRUE,
               pt.size = 0,
               ...) + 
    coord_cartesian(clip = "off") +
    theme_classic() +
    theme(
      plot.title = element_text(size = 7, colour = "black"),
      panel.grid.minor = element_blank(),
      panel.grid.major = element_line(size = 0.2),
      axis.line = element_line(size = 0.25),
      axis.ticks = element_line(size = 0.25),
      axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5, 
                                 size = 6, color = "black"),
      axis.title.x = element_blank(),
      axis.title.y = element_text(size = 6, color = "black"),
      axis.text.y = element_text(size = 6, color = "black"),
      legend.key.size = unit(0.50, "lines"),
      legend.position = c(1, 1),
      legend.direction = "horizontal",
      legend.justification = c(1, 0),
      legend.text = element_text(size = 6, colour = "black")
    )
  
  p$layers[[1]]$aes_params$size = 0.25 # violin stroke
  
  return(p)
}
```

```{r}
# umap function
FeaturePlot2 <- function(object = seur, feature, ...) {
  DefaultAssay(object) <- "SCT"
  FeaturePlot(object, 
              feature = feature, 
              split.by = "covid",
              pt.size = 0.1, 
              order = TRUE, 
              min.cutoff = "q10", 
              combine = TRUE,
              ...) &
    plot_annotation(title = feature) &
    theme_bw() +
    theme(panel.grid.major = element_line(size = 0.25),
          panel.grid.minor = element_blank(),
          legend.key.size = unit(0.50, "line"),
          legend.text = element_text(size = 6, angle = 90, hjust = 1),
          legend.position = "bottom",
          axis.title = element_text(size = 6),
          plot.title = element_text(size = 7),
          axis.title.y.right = element_blank(),
          axis.text = element_blank(),
          aspect.ratio = 1)
}
```


```{r fig.width=2.75, fig.asp=1}

for(i in all.genes[all.genes %in% rownames(seur)]) {
  vplot <- VlnPlot2(feature = i)
  fplot <- FeaturePlot2(feature = i, max.cutoff = "q99")
  
  cowplot::ggsave2(vplot, 
                   filename = paste0("../results/03_de-genes/plots/", i, "_violinplot.pdf"),
                   width = 3.5, height = 2, units = "in")
  
  cowplot::ggsave2(fplot, 
                   filename = paste0("../results/03_de-genes/plots/", i, "_on-umap.png"),
                   width = 3.5, height = 2.5, units = "in")
  
  vf <- vplot + fplot + 
  plot_layout(ncol = 1, widths = c(1, 0.5))
  print(vf)
}
```

For some genes, the umap plots and violin plots seem to disagree with each other. That is, the gene is expressed at higher level in "covid" than "control" according to the violin plot, but the colours appear stronger for "control" on umap plots. I think this is simply because of the differing number of cells from "control" and "covid". We have fewer cells from "covid" samples (as is evident also on the umap plots), so the lightness or sparseness of blue on umap plots just reflect that. Violin plots on the other hand scale the width of violins to the total number of cells in each group, so this difference is not seen in violin plots.

# Session Info
```{r}
sessionInfo()
```

